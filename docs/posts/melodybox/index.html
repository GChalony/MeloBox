<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>The MelodyBox - MelodyBox - an NFC Spotify player</title>
  <meta name="description" content="The MelodyBox is meant to give a physical support to music, as used to exist with vinyls and CDs. This requires two things :
 a physical object that can identifying music a reader which can read the music to play from the object and play it  The object is an NFC tag, and the reader is an NFC reader coupled with a rasperryPi.
What is convenient about this is that the NFC tag can be embeded in almost any kind of object, as long as it doesn&rsquo;t intefere with the radiowaves used to read it."><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "MelodyBox - an NFC Spotify player",
    
    "url": "https:\/\/gchalony.github.io\/MeloBox\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/gchalony.github.io\/MeloBox\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/gchalony.github.io\/MeloBox\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/gchalony.github.io\/MeloBox\/posts\/melodybox\/",
          "name": "The melody box"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : ""
  },
  "headline": "The MelodyBox",
  "description" : "The MelodyBox is meant to give a physical support to music, as used to exist with vinyls and CDs. This requires two things :\n a physical object that can identifying music a reader which can read the music to play from the object and play it  The object is an NFC tag, and the reader is an NFC reader coupled with a rasperryPi.\nWhat is convenient about this is that the NFC tag can be embeded in almost any kind of object, as long as it doesn\u0026rsquo;t intefere with the radiowaves used to read it.",
  "inLanguage" : "en",
  "wordCount":  626 ,
  "datePublished" : "2022-05-23T22:58:14",
  "dateModified" : "2022-05-23T22:58:14",
  "image" : "https:\/\/gchalony.github.io\/MeloBox\/",
  "keywords" : [ "" ],
  "mainEntityOfPage" : "https:\/\/gchalony.github.io\/MeloBox\/posts\/melodybox\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/gchalony.github.io\/MeloBox\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/gchalony.github.io\/MeloBox\/",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="The MelodyBox" />
<meta property="og:description" content="The MelodyBox is meant to give a physical support to music, as used to exist with vinyls and CDs. This requires two things :
 a physical object that can identifying music a reader which can read the music to play from the object and play it  The object is an NFC tag, and the reader is an NFC reader coupled with a rasperryPi.
What is convenient about this is that the NFC tag can be embeded in almost any kind of object, as long as it doesn&rsquo;t intefere with the radiowaves used to read it.">
<meta property="og:url" content="https://gchalony.github.io/MeloBox/posts/melodybox/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="MelodyBox - an NFC Spotify player" />

  <meta name="twitter:title" content="The MelodyBox" />
  <meta name="twitter:description" content="The MelodyBox is meant to give a physical support to music, as used to exist with vinyls and CDs. This requires two things :
 a physical object that can identifying music a reader which can read the â€¦">
  <meta name="twitter:card" content="summary" />
  <meta name="generator" content="Hugo 0.93.3" />
  <link rel="alternate" href="https://gchalony.github.io/MeloBox/index.xml" type="application/rss+xml" title="MelodyBox - an NFC Spotify player"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://gchalony.github.io/MeloBox/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://gchalony.github.io/MeloBox/css/syntax.css" /><link rel="stylesheet" href="https://gchalony.github.io/MeloBox/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://gchalony.github.io/MeloBox/">MelodyBox - an NFC Spotify player</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        

        

        
      </ul>
    </div>

    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="posts-heading">
              
                <h1>The MelodyBox</h1>
              
              
                <hr class="small">
              
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>The MelodyBox is meant to give a physical support to music, as used to exist with vinyls and CDs. This requires two things :</p>
<ul>
<li>a physical object that can identifying music</li>
<li>a reader which can read the music to play from the object and play it</li>
</ul>
<p>The object is an NFC tag, and the reader is an NFC reader coupled with a rasperryPi.</p>
<p>What is convenient about this is that the NFC tag can be embeded in almost any kind of object, as long as it doesn&rsquo;t intefere with the radiowaves used to read it. I have used floppy disks, a RubiksCube and Pop! figurines as such vectors.</p>
<p>The music is played through the spotify API, which has several advantages: any music on Spotify can be played (without having to download it locally first), we can create custom playlists to play and the playback can be controled from other Spotify devices, for example to change the volume or pause.</p>
<h2 id="final-result">Final result</h2>
<h2 id="how-it-works">How it works</h2>
<p>Alright, we know what we want to do, let&rsquo;s build it.</p>
<p>The first thing we need is to be able to play music.</p>
<p>pulseaudio, alsa
speakers, ampli, carte son</p>
<p>spotify
spotifyd
Spotify Web API
Interface : spotify-cli, MPRIS</p>
<p>We can now play a playlist, track or album with</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>spotify play --uri ...
</span></span></code></pre></div><p>Now comes the harder part : NFC.
We need :</p>
<ul>
<li>to be able to detect when a tag is approached</li>
<li>to read the URI stored in the memory</li>
<li>detect when it is removed</li>
</ul>
<p>Basic NFC concept
PN532 + NTAG210u</p>
<p>Putting it all together.</p>
<p>Box with buttons, leds.
Turn on/off RaspberryPi.
Buttons with interrupt
Led for feedback
Pinout</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Run the music server</span>
</span></span><span style="display:flex;"><span>    spotify<span style="color:#f92672">.</span>run()
</span></span><span style="display:flex;"><span>    nfc<span style="color:#f92672">.</span>wait_for_tag()
</span></span></code></pre></div><p>Making a daemon
systemd
system dbus</p>
<p>Ideas for later optimisations
Owning the NFC code
Interrupt</p>
<h3 id="nfc">NFC</h3>
<p>First, we need to communicate which music (album, playlist or track) using NFC. Near Field Communication is pretty complicated, especially because there are a lot of different standards, but the basic principal is quite simple :</p>
<ul>
<li>a tag host some kind of memory (up to a few kB depending on the tag&rsquo;s type)</li>
<li>a reader creates a magnoeletric field near the tags</li>
<li>this induces current in the tag, which can use it to power its circuitry</li>
<li>both the reader and the tag can modulate the field to communicate, with a protocol described in the [IEE-14443].</li>
</ul>
<p>Tags can have pretty advanced features like authentication or memory locking, but the simplest one are :</p>
<ul>
<li>identifying itself with a unique ID</li>
<li>read / write to a small memory</li>
</ul>
<p>We can use this memory to write a URI identifying which music we want to play, for example a Spotify URI : <code>spotify:album:5JY3b9cELQsoG7D5TJMOgw</code>. I use NFC Tool to flash the URI from a smartphone equiped with NFC. I used NTAG210u as they are cheap and small enough to be embeded in almost any object.</p>
<p>The reading is done with a PN532 chip, connected to a RaspberryPi over I2C. I initially chose I2C because it allows to plus multiple readers on the same pins, and even though I ended using only one reader, I stuck to this choice.</p>
<p>I struggled quite a lot to use the sensor, as I&rsquo;ve found that there are not so many tools to use NFC in linux. The reference is <code>libnfc</code>, which is a librairie to use NFC, and also provides some tool to work with it. I&rsquo;ve use <code>nfc-poll</code> quite a lot to wait for a tag to be detected.<br>
<code>libfreefare</code> is another library which build on top of it to provide more convenient APIs for MIFARE cards.<br>
I use <code>nfc-mfultralight</code> to read the content of the memory and parse it. I unfortunately didn&rsquo;t manage to use any other tool like <code>ntag-detect</code> or use the <code>pn532pi</code> python package.</p>
<p><img src="/MeloBox/rpi_pins.png" alt="pinout"></p>
<p><img src="/MeloBox/box.svg" alt="box"></p>


        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
          
        </ul>
      


      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;&copy;
          
            2022
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://gchalony.github.io/MeloBox/">MelodyBox - an NFC Spotify player</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.93.3</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://gchalony.github.io/MeloBox/js/main.js"></script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://gchalony.github.io/MeloBox/js/load-photoswipe.js"></script>









    
  </body>
</html>

